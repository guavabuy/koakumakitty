# 倪师口径规则说明书（内部版）

## 文档信息
- 版本：Phase 3 v1.0
- 更新日期：2026-01-02
- 适用范围：大运/流年/命理推演模块

---

## 一、规则索引

| 规则编号 | 规则名称 | 类型 | 来源 |
|----------|----------|------|------|
| NiShi-TJ-01 | 大运顺逆判断 | 严格口径 | 《天纪》大运章 |
| NiShi-TJ-02 | 起运岁数计算 | 严格口径 | 《天纪》起运章 |
| NiShi-TJ-03 | 大运干支排列 | 严格口径 | 《天纪》排运章 |
| NiShi-TJ-04 | 流年干支计算 | 严格口径 | 通用历法 |
| NiShi-TJ-05 | 天干五合/相冲 | 严格口径 | 《天纪》合化章 |
| NiShi-TJ-06 | 地支六合/六冲/三刑/六害 | 严格口径 | 《天纪》刑冲合害章 |
| NiShi-TJ-07 | 运势叠加权重 | 启发式 | 综合调整 |

---

## 二、详细规则说明

### NiShi-TJ-01：大运顺逆判断

**规则内容：**
- 阳年生男、阴年生女 → **顺排大运**
- 阴年生男、阳年生女 → **逆排大运**

**阴阳年判断：**
- 阳年：年干为甲、丙、戊、庚、壬
- 阴年：年干为乙、丁、己、辛、癸

**代码实现：**
```javascript
const isYangYear = STEM_YIN_YANG[yearStem] === '阳';
const isMale = gender === 'male';
const isForward = (isYangYear && isMale) || (!isYangYear && !isMale);
```

**验证方式：** 与香港/台湾主流排盘软件对照

---

### NiShi-TJ-02：起运岁数计算

**规则内容：**
1. 顺排：从出生日时到**下一个节**的天数
2. 逆排：从出生日时到**上一个节**的天数
3. 天数 ÷ 3 = 起运岁数（3天 = 1岁，1天 ≈ 4个月）

**节与中气区分：**
- 节（12个）：立春、惊蛰、清明、立夏、芒种、小暑、立秋、白露、寒露、立冬、大雪、小寒
- 中气（12个）：雨水、春分、谷雨、小满、夏至、大暑、处暑、秋分、霜降、小雪、冬至、大寒

**重要说明：**
起运计算只看"节"，不看"中气"。

**已知偏差：**
- 部分排盘软件使用"四舍五入"，本实现使用"向下取整 + 余数月"
- 差异通常在 ±1个月内，不影响大运走势

---

### NiShi-TJ-03：大运干支排列

**规则内容：**
- 顺排：从月柱干支开始，天干地支各加1
- 逆排：从月柱干支开始，天干地支各减1
- 每步大运管10年

**示例（月柱辛巳，顺排）：**
- 第1步：壬午
- 第2步：癸未
- 第3步：甲申
- ...

**示例（月柱辛巳，逆排）：**
- 第1步：庚辰
- 第2步：己卯
- 第3步：戊寅
- ...

---

### NiShi-TJ-04：流年干支计算

**规则内容：**
- 天干：(年份 - 4) % 10
- 地支：(年份 - 4) % 12

**示例：**
- 2026年：(2026-4) % 10 = 2 → 丙；(2026-4) % 12 = 6 → 午 → 丙午年

---

### NiShi-TJ-05：天干五合与相冲

**天干五合：**
| 组合 | 合化结果 |
|------|----------|
| 甲己 | 合化土 |
| 乙庚 | 合化金 |
| 丙辛 | 合化水 |
| 丁壬 | 合化木 |
| 戊癸 | 合化火 |

**天干相冲：**
- 甲庚冲、乙辛冲、丙壬冲、丁癸冲

**说明：** 戊己居中，无冲

---

### NiShi-TJ-06：地支六合/六冲/三刑/六害

**地支六合：**
| 组合 | 合化结果 |
|------|----------|
| 子丑 | 合化土 |
| 寅亥 | 合化木 |
| 卯戌 | 合化火 |
| 辰酉 | 合化金 |
| 巳申 | 合化水 |
| 午未 | 合化火/土 |

**地支六冲：**
- 子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲

**地支三刑：**
- 寅巳申：无恩之刑
- 丑戌未：恃势之刑
- 子卯：无礼之刑
- 辰辰、午午、酉酉、亥亥：自刑

**地支六害：**
- 子未害、丑午害、寅巳害、卯辰害、申亥害、酉戌害

---

### NiShi-TJ-07：运势叠加权重（启发式）

**权重说明：**
此为综合多种因素的启发式算法，非严格命理口径。

| 因素 | 影响 | 权重 |
|------|------|------|
| 流年干与日主五合 | 有贵人助力 | +10 |
| 流年干与日主相冲 | 易有波折 | -10 |
| 流年干生日主 | 运势顺遂 | +8 |
| 流年干克日主 | 需谨慎 | -8 |
| 流年支与年支六合 | 太岁相助 | +8 |
| 流年支与年支六冲 | 冲太岁 | -15 |
| 流年支与年支六害 | 害太岁 | -8 |
| 本命年 | 值太岁 | -5 |
| 大运流年干合 | 平顺 | +5 |
| 大运流年干冲 | 变动 | -5 |
| 大运流年支冲 | 交运注意 | -8 |

**评分等级：**
- 80分以上：上吉
- 65-79分：小吉
- 50-64分：平
- 35-49分：小凶
- 35分以下：凶

---

## 三、已知偏差与限制

### 1. 起运时间精度
- 本实现按"天"计算，实际应按"时辰"精确到小时
- 差异通常在 ±4个月内

### 2. 真太阳时
- 本实现使用北京时间 (UTC+8)
- 未实现真太阳时校正（根据经度调整）
- 对于边界时辰可能有1个时辰的偏差

### 3. 合化条件
- 本实现仅检测是否存在合，未判断"是否化成"
- 实际合化需要满足月令、得时等条件

### 4. 三合局
- 本实现仅检测两两组合，未实现完整的三合局判断
- 三合局需要三个地支同时出现

---

## 四、能力分类

### 严格口径（可对账验证）
- 四柱干支计算
- 大运顺逆方向
- 起运岁数（±1年误差）
- 大运干支排列
- 天干五合/相冲判断
- 地支六合/六冲/刑害判断

### 启发式（参考性质）
- 运势分数（基于权重叠加）
- 运势等级（基于分数区间）
- 建议文案（基于规则触发）

---

## 五、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2026-01-02 | 初始版本，阶段3完成 |

---

## 六、参考资料

1. 倪海厦《天纪》视频讲座
2. 倪海厦《天纪》讲义
3. 《渊海子平》
4. 《三命通会》
5. 主流排盘软件对照验证

---

*本文档仅供内部开发参考，不代表命理学权威解释。*

