# 历法核心口径说明

## 概述

本文档说明猫咪算命屋项目的八字/历法核心计算口径，基于倪海厦《天纪》理论。

## 核心原则

### 1. 年柱口径：立春换年

**规则**：命理年以立春为界，不是公历1月1日。

- 立春**之前**出生 → 属于**上一年**
- 立春**当天或之后**出生 → 属于**当年**

**示例**：

| 出生日期 | 立春时刻 | 命理年 | 年柱 |
|---------|---------|-------|------|
| 1990-02-03 | 1990-02-04 10:15 | 1989 | 己巳 |
| 1990-02-04 12:00 | 1990-02-04 10:15 | 1990 | 庚午 |
| 2025-02-03 | 2025-02-03 22:10 | 2024 | 甲辰 |
| 2025-02-04 | 2025-02-03 22:10 | 2025 | 乙巳 |

### 2. 月柱口径：节气定月

**规则**：月建以节气为界，不是公历月份。

- 每月从"节"开始（非"气"）
- 寅月从立春起，依次类推

**月建与节气对照表**：

| 月建 | 地支 | 起始节气 | 大约公历 |
|-----|-----|---------|---------|
| 正月 | 寅 | 立春 | 2月4日前后 |
| 二月 | 卯 | 惊蛰 | 3月6日前后 |
| 三月 | 辰 | 清明 | 4月5日前后 |
| 四月 | 巳 | 立夏 | 5月6日前后 |
| 五月 | 午 | 芒种 | 6月6日前后 |
| 六月 | 未 | 小暑 | 7月7日前后 |
| 七月 | 申 | 立秋 | 8月8日前后 |
| 八月 | 酉 | 白露 | 9月8日前后 |
| 九月 | 戌 | 寒露 | 10月8日前后 |
| 十月 | 亥 | 立冬 | 11月7日前后 |
| 冬月 | 子 | 大雪 | 12月7日前后 |
| 腊月 | 丑 | 小寒 | 1月6日前后 |

**月干计算**（五虎遁月歌诀）：

| 年干 | 正月(寅月)起始月干 |
|-----|------------------|
| 甲、己 | 丙 |
| 乙、庚 | 戊 |
| 丙、辛 | 庚 |
| 丁、壬 | 壬 |
| 戊、癸 | 甲 |

### 3. 日柱口径：儒略日算法

**规则**：使用统一的儒略日算法计算日柱。

**基准日**：1900年1月31日 = 甲戌日

**算法**：
```
日干索引 = (儒略日 - 基准儒略日) % 10
日支索引 = (儒略日 - 基准儒略日) % 12
```

### 4. 时柱口径：时辰起点

**规则**：时辰按起点计算（用户选择方案a）。

**时辰对照表**：

| 时辰 | 地支 | 起始时间 | 结束时间 |
|-----|-----|---------|---------|
| 子时 | 子 | 23:00 | 01:00 |
| 丑时 | 丑 | 01:00 | 03:00 |
| 寅时 | 寅 | 03:00 | 05:00 |
| 卯时 | 卯 | 05:00 | 07:00 |
| 辰时 | 辰 | 07:00 | 09:00 |
| 巳时 | 巳 | 09:00 | 11:00 |
| 午时 | 午 | 11:00 | 13:00 |
| 未时 | 未 | 13:00 | 15:00 |
| 申时 | 申 | 15:00 | 17:00 |
| 酉时 | 酉 | 17:00 | 19:00 |
| 戌时 | 戌 | 19:00 | 21:00 |
| 亥时 | 亥 | 21:00 | 23:00 |

**时干计算**（五鼠遁日歌诀）：

| 日干 | 子时起始时干 |
|-----|------------|
| 甲、己 | 甲 |
| 乙、庚 | 丙 |
| 丙、辛 | 戊 |
| 丁、壬 | 庚 |
| 戊、癸 | 壬 |

### 5. 时区策略

**规则**：统一使用北京时间 (Asia/Shanghai, UTC+8)。

- 所有计算默认用户处于UTC+8时区
- 节气时刻以北京时间为准
- 暂不支持真太阳时/经度修正

## 受影响的功能模块

| 模块 | 受影响项 | 口径变更 |
|-----|---------|---------|
| 八字排盘 (bazi.js) | 年柱、月柱 | 立春换年、节气定月 |
| 择日 (auspicious.js) | 月建、建除 | 节气月建 |
| 姻缘配对 (marriage.js) | 年柱、生肖、命卦 | 命理年 |
| 每日运势 (daily.js) | 年柱 | 立春换年 |
| 2026年运势 (yearly2026.js) | 年柱、生肖 | 命理年 |
| 风水 (fengshui.js) | 命卦 | 命理年 |

## 验收样例

### 立春边界测试

| 出生日期时间 | 预期年柱 | 预期月柱 | 说明 |
|------------|---------|---------|-----|
| 1990-02-03 午时 | 己巳 | 丁丑 | 立春前 |
| 1990-02-04 午时 | 庚午 | 戊寅 | 立春后 |
| 2024-02-04 午时 | 甲辰 | 丙寅 | 立春后 |
| 2025-02-03 午时 | 甲辰 | 丁丑 | 立春前 |
| 2025-02-04 午时 | 乙巳 | 戊寅 | 立春后 |

### 节气月切换测试

| 日期 | 节气 | 预期月支 | 说明 |
|-----|-----|---------|-----|
| 2024-03-04 | 惊蛰前 | 寅 | 仍为寅月 |
| 2024-03-05 午时 | 惊蛰后 | 卯 | 进入卯月 |
| 2024-04-04 午时 | 清明后 | 辰 | 进入辰月 |

### 日柱验证

| 日期 | 预期日柱 | 说明 |
|-----|---------|-----|
| 1900-01-31 | 甲戌 | 基准日 |
| 2000-01-01 | 戊午 | |
| 2024-01-01 | 甲辰 | |

## 边界情况说明

### 1. 子时跨日

- 23:00-00:59 属于**当日**子时
- 按照时辰起点规则，用户选择子时时默认使用23:00

### 2. 节气精确时刻

- 节气时刻精确到分钟
- 使用天文算法计算（VSOP87简化版）
- 精度约1-2分钟

### 3. 已知限制

- 暂不支持真太阳时修正
- 暂不支持经度修正
- 农历日期使用简化算法
- 节气数据覆盖1900-2100年

## 核心模块文件

| 文件 | 说明 |
|-----|-----|
| `js/core/solar_terms.js` | 节气数据与计算 |
| `js/core/calendar.js` | 历法核心API |
| `js/core/calendar_test.js` | 验收测试样例 |

## API 使用示例

```javascript
import ChineseCalendar from './core/calendar.js';

// 构建出生时间（使用时辰起点）
const birthDateTime = ChineseCalendar.buildBirthDateTime('1990-05-15', 6); // 午时

// 计算四柱
const { pillars, zodiac, debug } = ChineseCalendar.calculateFourPillars(birthDateTime, 6);

console.log(pillars.year);  // { stem: '庚', branch: '午', ... }
console.log(pillars.month); // { stem: '辛', branch: '巳', ... }
console.log(pillars.day);   // { stem: '...', branch: '...', ... }
console.log(pillars.hour);  // { stem: '...', branch: '午', ... }
console.log(zodiac);        // '马'

// debug 包含调试信息
console.log(debug.mingLiYear);       // 命理年
console.log(debug.isBeforeLiChun);   // 是否在立春前
console.log(debug.solarTermMonth);   // 节气月信息
```

## 更新日志

| 日期 | 版本 | 变更 |
|-----|-----|-----|
| 2026-01-02 | 1.0.0 | 初始版本，实现节气口径 |

---

*本文档由CTO审核，符合倪师《天纪》理论口径。*

